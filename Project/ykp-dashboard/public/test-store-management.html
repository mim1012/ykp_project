<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧪 실제 매장 관리 테스트</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="csrf-token" content="test-token">
    <script src="/js/session-stability.js"></script>
</head>
<body class="bg-gray-50">
    <div class="max-w-7xl mx-auto py-6 px-4">
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-medium">🧪 실제 매장 목록 테스트</h2>
                    <button class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        ➕ 매장 추가
                    </button>
                </div>
                <div id="stores-grid" class="bg-white rounded border">
                    <div class="p-4 text-center text-gray-500">매장 데이터 로딩 중...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 🚀 실제 매장 데이터 로드 및 버튼 테스트
        async function loadRealStores() {
            console.log('🔄 실제 매장 데이터 로드');
            
            try {
                const response = await fetch('/api/dev/stores/list');
                const data = await response.json();
                
                if (data.success && data.data) {
                    console.log('✅ 매장 데이터 로드됨:', data.data.length + '개');
                    
                    // 지사별 그룹화
                    const storesByBranch = {};
                    data.data.forEach(store => {
                        const branchName = store.branch?.name || '미배정 지사';
                        if (!storesByBranch[branchName]) {
                            storesByBranch[branchName] = [];
                        }
                        storesByBranch[branchName].push(store);
                    });
                    
                    // HTML 생성 (실제 매장 관리와 동일한 구조)
                    let html = `<div class="space-y-6">`;
                    
                    Object.entries(storesByBranch).forEach(([branchName, stores]) => {
                        html += `
                            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                                <div class="bg-gradient-to-r from-blue-500 to-indigo-600 px-6 py-4">
                                    <h3 class="text-xl font-bold text-white">🏢 ${branchName} (${stores.length}개 매장)</h3>
                                </div>
                                <div class="p-6">
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        `;
                        
                        stores.forEach(store => {
                            html += `
                                <div class="bg-gray-50 rounded-lg p-4 hover:bg-white hover:shadow-md transition-all border">
                                    <div class="flex justify-between items-start mb-3">
                                        <h4 class="font-bold text-lg">${store.name}</h4>
                                        <span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">✅ 운영중</span>
                                    </div>
                                    <div class="text-sm text-gray-600 space-y-1 mb-3">
                                        <p><span class="font-medium">코드:</span> ${store.code}</p>
                                        <p><span class="font-medium">점주:</span> ${store.owner_name || '미등록'}</p>
                                        <p><span class="font-medium">연락처:</span> ${store.phone || '미등록'}</p>
                                    </div>
                                    
                                    <div class="mt-3 flex gap-2">
                                        <button data-store-id="${store.id}" data-store-name="${store.name}" class="store-edit-btn px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">✏️ 수정</button>
                                        <button data-store-id="${store.id}" data-store-name="${store.name}" class="store-account-btn px-3 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600">👤 계정</button>
                                        <button data-store-id="${store.id}" data-store-name="${store.name}" class="store-stats-btn px-3 py-1 bg-purple-500 text-white text-xs rounded hover:bg-purple-600">📊 성과</button>
                                        <button data-store-id="${store.id}" data-store-name="${store.name}" class="store-delete-btn px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">🗑️ 삭제</button>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    document.getElementById('stores-grid').innerHTML = html;
                    
                    // 이벤트 리스너 등록
                    setupStoreButtons();
                    
                } else {
                    document.getElementById('stores-grid').innerHTML = '<div class="p-4 text-center text-red-500">매장 데이터 로드 실패</div>';
                }
            } catch (error) {
                console.error('매장 데이터 로드 오류:', error);
                document.getElementById('stores-grid').innerHTML = '<div class="p-4 text-center text-red-500">오류: ' + error.message + '</div>';
            }
        }
        
        // 🛠️ 매장 버튼 이벤트 설정 (실제 코드와 동일)
        function setupStoreButtons() {
            console.log('🛠️ 매장 버튼 이벤트 등록');
            
            document.addEventListener('click', function(e) {
                const target = e.target;
                const storeId = target.dataset.storeId;
                const storeName = target.dataset.storeName;
                
                if (!storeId) return;
                
                if (target.classList.contains('store-edit-btn')) {
                    console.log('✏️ 수정 클릭:', storeId, storeName);
                    alert(`매장 수정: ${storeName} (ID: ${storeId})\n\n실제 환경에서는 편집 모달이 열립니다.`);
                    
                } else if (target.classList.contains('store-account-btn')) {
                    console.log('👤 계정 클릭:', storeId, storeName);
                    if (confirm(`${storeName} 매장의 직원 계정을 생성하시겠습니까?`)) {
                        alert('✅ 계정 생성 기능이 실행됩니다.');
                    }
                    
                } else if (target.classList.contains('store-stats-btn')) {
                    console.log('📊 성과 클릭:', storeId, storeName);
                    alert(`${storeName} 매장 성과 분석\n\n• 월 매출 현황\n• 개통 실적\n• 목표 달성률\n\n성과 대시보드가 열립니다.`);
                    
                } else if (target.classList.contains('store-delete-btn')) {
                    console.log('🗑️ 삭제 클릭:', storeId, storeName);
                    if (confirm(`⚠️ 정말로 "${storeName}" 매장을 삭제하시겠습니까?\n\n삭제 시:\n• 매장 정보 완전 삭제\n• 관련 계정 비활성화\n• 정산 데이터 보관\n\n이 작업은 되돌릴 수 없습니다.`)) {
                        alert('🗑️ 매장 삭제 API가 호출됩니다.\n(테스트 환경에서는 실제 삭제 안함)');
                    }
                }
            });
            
            console.log('✅ 이벤트 리스너 등록 완료');
        }
        
        // 자동 로드
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 페이지 로드 완료 - 실제 매장 데이터 로드');
            loadRealStores();
        });
    </script>
</body>
</html>