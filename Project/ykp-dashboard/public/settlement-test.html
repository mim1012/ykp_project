<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧪 정산 시스템 E2E 테스트</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <div class="max-w-7xl mx-auto py-6 px-4">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-gray-900">🧪 YKP ERP 정산 시스템 E2E 테스트</h1>
                <p class="text-gray-600 mt-2">전체 플로우 검증: 매장등록 → 정산입력 → 통계분석</p>
            </div>
            
            <!-- 테스트 진행 상황 -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                    <h3 class="font-bold text-green-800">1️⃣ 매장 등록</h3>
                    <p class="text-sm text-green-600" id="store-status">테스트 중...</p>
                </div>
                <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <h3 class="font-bold text-blue-800">2️⃣ 정산 입력</h3>
                    <p class="text-sm text-blue-600" id="settlement-status">대기 중...</p>
                </div>
                <div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <h3 class="font-bold text-purple-800">3️⃣ 통계 분석</h3>
                    <p class="text-sm text-purple-600" id="stats-status">대기 중...</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 class="font-bold text-gray-800">4️⃣ 최종 검증</h3>
                    <p class="text-sm text-gray-600" id="final-status">대기 중...</p>
                </div>
            </div>
            
            <!-- 테스트 결과 -->
            <div class="bg-gray-50 rounded-lg p-6">
                <h2 class="text-lg font-bold mb-4">🔍 실시간 테스트 결과</h2>
                <div id="test-results" class="space-y-2 font-mono text-sm">
                    <div class="text-blue-600">테스트 시작 준비 중...</div>
                </div>
            </div>
            
            <!-- 수동 테스트 버튼들 -->
            <div class="mt-6 flex space-x-4">
                <button onclick="testStores()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                    🏪 매장 데이터 테스트
                </button>
                <button onclick="testSettlement()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    💰 정산 시스템 테스트
                </button>
                <button onclick="testStats()" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">
                    📊 통계 시스템 테스트
                </button>
                <button onclick="runFullTest()" class="px-6 py-2 bg-red-500 text-white rounded hover:bg-red-600 font-bold">
                    🚀 전체 플로우 테스트
                </button>
            </div>
            
            <!-- 빠른 링크 -->
            <div class="mt-8 p-4 bg-blue-50 rounded-lg">
                <h3 class="font-bold text-blue-800 mb-2">🔗 빠른 링크</h3>
                <div class="flex flex-wrap gap-2">
                    <a href="/management/stores" class="px-3 py-1 bg-white border rounded text-sm hover:bg-gray-50">매장 관리</a>
                    <a href="/monthly-settlement" class="px-3 py-1 bg-white border rounded text-sm hover:bg-gray-50">월마감정산</a>
                    <a href="/management/branches" class="px-3 py-1 bg-white border rounded text-sm hover:bg-gray-50">지사 관리</a>
                    <a href="/admin/accounts" class="px-3 py-1 bg-white border rounded text-sm hover:bg-gray-50">계정 관리</a>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 🧪 E2E 테스트 스크립트
        let testResults = [];
        
        function addResult(message, status = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                success: 'text-green-600',
                error: 'text-red-600', 
                info: 'text-blue-600',
                warning: 'text-yellow-600'
            };
            
            testResults.push(`[${timestamp}] ${message}`);
            
            const resultDiv = document.getElementById('test-results');
            resultDiv.innerHTML = testResults.map(result => 
                `<div class="${colors[status] || colors.info}">${result}</div>`
            ).join('');
            
            // 자동 스크롤
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }
        
        // 1️⃣ 매장 데이터 테스트
        async function testStores() {
            addResult('🏪 매장 데이터 테스트 시작...', 'info');
            document.getElementById('store-status').textContent = '테스트 중...';
            
            try {
                const response = await fetch('/api/dev/stores/list');
                const data = await response.json();
                
                if (data.success && data.data.length >= 7) {
                    addResult(`✅ 매장 데이터 정상: ${data.data.length}개 매장 확인`, 'success');
                    addResult(`✅ 신규 매장 포함: ${data.data.find(s => s.name.includes('테스트')) ? '확인됨' : '누락'}`, 'success');
                    document.getElementById('store-status').textContent = `✅ 성공 (${data.data.length}개)`;
                    return true;
                } else {
                    throw new Error('매장 데이터 부족');
                }
            } catch (error) {
                addResult(`❌ 매장 테스트 실패: ${error.message}`, 'error');
                document.getElementById('store-status').textContent = '❌ 실패';
                return false;
            }
        }
        
        // 2️⃣ 정산 시스템 테스트
        async function testSettlement() {
            addResult('💰 정산 시스템 테스트 시작...', 'info');
            document.getElementById('settlement-status').textContent = '테스트 중...';
            
            try {
                // 정산 데이터 확인
                const response = await fetch('/api/monthly-settlements');
                const data = await response.json();
                
                if (data.success) {
                    addResult(`✅ 정산 API 정상 작동`, 'success');
                    addResult(`✅ 정산 데이터: ${data.data ? data.data.length : 0}건 확인`, 'success');
                    document.getElementById('settlement-status').textContent = '✅ API 정상';
                    return true;
                } else {
                    throw new Error('정산 API 응답 오류');
                }
            } catch (error) {
                addResult(`❌ 정산 테스트 실패: ${error.message}`, 'error');
                document.getElementById('settlement-status').textContent = '❌ 실패';
                return false;
            }
        }
        
        // 3️⃣ 통계 시스템 테스트
        async function testStats() {
            addResult('📊 통계 시스템 테스트 시작...', 'info');
            document.getElementById('stats-status').textContent = '테스트 중...';
            
            try {
                const response = await fetch('/api/dashboard/overview');
                const data = await response.json();
                
                if (data.success && data.data) {
                    addResult(`✅ 대시보드 API 정상`, 'success');
                    addResult(`✅ 월 매출: ${data.data.this_month_sales?.toLocaleString() || 0}원`, 'success');
                    addResult(`✅ 달성률: ${data.data.achievement_rate || 0}%`, 'success');
                    document.getElementById('stats-status').textContent = '✅ 통계 정상';
                    return true;
                } else {
                    throw new Error('통계 API 응답 오류');
                }
            } catch (error) {
                addResult(`❌ 통계 테스트 실패: ${error.message}`, 'error');
                document.getElementById('stats-status').textContent = '❌ 실패';
                return false;
            }
        }
        
        // 🚀 전체 플로우 테스트
        async function runFullTest() {
            addResult('🚀 전체 E2E 플로우 테스트 시작!', 'info');
            
            const storeTest = await testStores();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const settlementTest = await testSettlement();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const statsTest = await testStats();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 최종 결과
            const allPassed = storeTest && settlementTest && statsTest;
            
            if (allPassed) {
                addResult('🎉 전체 플로우 테스트 성공! 실전 사용 가능!', 'success');
                document.getElementById('final-status').textContent = '🎉 성공';
                document.getElementById('final-status').className = 'text-sm text-green-600 font-bold';
            } else {
                addResult('❌ 일부 테스트 실패. 추가 수정 필요', 'error');
                document.getElementById('final-status').textContent = '❌ 부분 실패';
                document.getElementById('final-status').className = 'text-sm text-red-600 font-bold';
            }
        }
        
        // 자동 초기 테스트
        document.addEventListener('DOMContentLoaded', function() {
            addResult('🔄 시스템 상태 확인 중...', 'info');
            setTimeout(() => {
                runFullTest();
            }, 2000);
        });
    </script>
</body>
</html>